---
title: "Group project assessment"
author: '[update with group members'' exam numbers]'
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Task 1: Reproducing and improving figures

```{r load-wrangle}
# load and wrangle the data here
library(tidyverse)
library(here)
library(patchwork)
library(janitor)
library(ggrepel)

postpartum_depression <- read.csv(here("data", "HIIT-postpartum-depression.csv")) %>% 
  clean_names() %>% 
  mutate(across(where(is.character), ~ na_if(., "#NULL!")))


```


### Figure 3
```{r figure-3}

# Write your code for reproducing, and then improving Figure 3. Present both figures together. Under the figures, explain how you've improved Figure 3 and why you consider this an improvement.

fig3_PPD <- postpartum_depression %>% 
  select(starts_with("Edin")|starts_with("Int")) %>% #to select cols related to the edinburgh depression scale and intervention group
  rename("epdss" = edinburg_postnatal_depression_scale_score) %>% #rename for convenience
  transform(epdss = as.numeric(epdss)) %>% #convert from character to number
  drop_na()
  
#table with totals of each group
categorised_PPD_score <- fig3_postpartum_depression %>% 
  #categorising depression scores
  mutate(depression_level = case_when(epdss < 10 ~ "norm",
                                      epdss >= 10 & epdss <= 11 ~ "slightly_increased",
                                      epdss > 11 ~ "increased")) %>% 
  #creating totals of each depression score and grouping them by type of intervention
  group_by(depression_level, intervention_group) %>% 
  count(depression_level) %>% 
  pivot_wider(names_from = depression_level, values_from = n) %>% 
  #finding the totals in each intervention group
  mutate(totals = rowSums(across(c("increased" : "slightly_increased"))))



#finding percentages
percents_PPD_score <- categorised_PPD_score %>% 
  #finding percentages in each column and changing the name of the column
  rowwise() %>% 
  mutate(across(c(increased:slightly_increased), 
                ~ .x/totals*100, 
                .names = "percent_{.col}")) %>% 
  select(c(intervention_group, starts_with("percent"))) %>% 
  pivot_longer(starts_with("percent"), names_to = "depression_score", values_to = "percents") %>% 
  #changing the names of the intervention group - done after plotting to match to the original
  mutate(intervention_group = recode(intervention_group, "2" = "EDU - Educational Intervention Group",
                                     "1" = "HIIT - High Intensity Interval Training Group"))


#plot chart 
original_PPD_plot <- percents_PPD_score %>% 
  #re-ordering the position each variable appears in the original graph
  mutate(depression_score = fct_relevel(depression_score, 
                                        "percent_increased", "percent_slightly_increased", 
                                        "percent_norm"),
         intervention_group = fct_relevel(intervention_group, 
                                           "HIIT - High Intensity Interval Training Group", 
                                           "EDU - Educational Intervention Group")) %>% 
  ggplot(aes(x = percents, y = intervention_group, fill = depression_score)) +
  geom_col(width = 0.25) +
  #adjusting x-axis scale
  scale_x_continuous(breaks = seq(0, 100, by = 10), 
                     labels = scales :: label_percent(accuracy = 0.01, scale = 1)) +
  #adjusting the figure legend (changing text and fill colour) to match the original
  scale_fill_manual(breaks = c("percent_norm", "percent_slightly_increased", "percent_increased"), 
                    labels = c("percent_norm" = "range indicating the norm (below 10 points)",
                               "percent_slightly_increased" = 
                                 "slightly increased severity of PPD symptoms (10-11 points)",
                               "percent_increased" = "increased severity of PPD symptoms (12 or more points)"),
                    values = c("percent_norm" = "#8DB6F8", 
                                 "percent_slightly_increased" = "#083B92", 
                                 "percent_increased" = "#C32113")) +
  labs(x = "", y = "") + # removing labels for axis
  #formatting graph
  theme(axis.text = element_text(size = 8),
        legend.title = element_blank(),
        legend.position = "bottom",
        legend.direction = "vertical",
        panel.background = element_rect(fill = "white"),
        panel.grid.major.x = element_line(colour = "#D8D8D8", linewidth = 0.5),
        axis.ticks = element_blank())

original_PPD_plot



##IMPROVED PLOT

#preparing data to make a better plot
improved_categorised_PPD <- categorised_PPD_score %>%
  #re-code intervention group
  mutate(intervention_group = recode(intervention_group, "2" = "EDU",
                                     "1" = "HIIT")) %>% 
  select(!totals) %>% 
  pivot_longer(c(increased:slightly_increased), names_to = "depression_score", values_to = "count")


#improved plot
improved_PPD_plot <- improved_categorised_PPD %>% 
  #re-ordering position of variables on the plot
   mutate(depression_score = fct_relevel(depression_score, 
                                        "increased", "slightly_increased", 
                                        "norm")) %>% 
  ggplot(aes(x = intervention_group, y = count, fill = depression_score)) +
  geom_col(width = 0.3) +
  # #adjusting the figure legend (changing text and fill colour)
  scale_fill_manual(breaks = c("norm", "slightly_increased", "increased"), 
                    labels = c("norm" = "range indicating the norm (below 10 points)",
                               "slightly_increased" = 
                                 "slightly increased severity of PPD symptoms (10-11 points)",
                               "increased" = "increased severity of PPD symptoms (12 or more points)"),
                    values = c("norm" = "#8DB6F8", 
                                 "slightly_increased" = "#083B92", 
                                 "increased" = "#C32113")) +
  #changing break length in scales on y-axis
  scale_y_continuous(breaks = seq(0,35, by = 5)) +
  #adding captions and labels to the axis
  labs(caption = ("EDU = Educational Intervention Group
                  HIIT = High Intensity Interval Training Group"),
       x = "Intervention Group", 
       y = "Count",
       fill = "Categories of Edinburgh Postnatal Depression Scale") +
  #final formatting
  theme(axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white"),
        panel.grid.major.y = element_line(colour = "darkgrey", linewidth = 0.5),
        panel.grid.minor.y = element_line(colour = "#D8D8D8", linewidth = 0.5),
        plot.caption.position = "plot", 
        plot.caption = element_text(size = 10.5))
  

improved_PPD_plot
```


### Figure 4
```{r figure-4}
# Write your code for reproducing, and then improving Figure 4. Present both figures together. Under the figures, explain how you've improved Figure 4 and why you consider this an improvement.


# Tidy table for graph
psych_wellbeing <- postpartum_depression %>% 
  select(intervention_group, pre_fs_scale, post_fs_score, postnatal_florishing_scale_score) %>% 
  mutate(
    # Convert intervention_group before pivoting
    intervention_group = recode(intervention_group, "1" = "HIIT - High Intensity Interval Training Group", "2" = "EDU - Education"),
    pre_fs_scale = as.numeric(pre_fs_scale),
    post_fs_score = as.numeric(post_fs_score),
    postnatal_florishing_scale_score = as.numeric(postnatal_florishing_scale_score)
  ) %>% 
  pivot_longer(
    cols = c(pre_fs_scale, post_fs_score, postnatal_florishing_scale_score),
    names_to = "time",
    values_to = "fs_score"
  ) %>% 
  drop_na()

# Create summary statistics for plotting
psych_summary <- psych_wellbeing %>% 
  group_by(intervention_group, time) %>% 
  summarise(
    mean = mean(fs_score),
    sd = sd(fs_score),
    
    # Stats for advanced plot
    n = n(),
    se = sd/sqrt(n),
    t_value = qt(0.975, n - 1),
    ci_lower = mean - t_value * se,
    ci_upper = mean + t_value * se,
    .groups = "drop"
  ) %>% 
  mutate(
    # Fix the factor levels and labels to match the order
    time = factor(time, 
                  levels = c("pre_fs_scale", "post_fs_score", "postnatal_florishing_scale_score"),
                  labels = c("Before the intervention\n(II trimester of pregnancy)", 
                             "After the intervention\n(III trimester of pregnancy)", 
                             "Follow-up\n(± 5 months postpartum)")),
  )

# Plot graph
ggplot(psych_summary, 
       aes(x = time, y = mean, group = intervention_group)) +
  
  geom_line(
    aes(linetype = intervention_group),
    linewidth = 0.8) +
  
  geom_errorbar(
    aes(ymin = mean - sd, ymax = mean + sd),
    width = 0.08
  ) +
  
  geom_text_repel( # To fix labelling on graph
    aes(label = paste0("M = ", round(mean, 2))),
    size = 3
  ) +
  
  scale_linetype_manual(
    values = c("solid", "dashed")
  ) +
  
  scale_y_continuous(
    breaks = seq(40, 60, 2),
    labels = sprintf("%.2f", seq(40, 60, 2)) # to replicate s.f. of original graph
  ) +
  
  labs(
    x = "Psychological well-being (Flourishing Scale)",
    y = NULL,
    linetype = NULL
  ) +
  
  theme_minimal() +
  theme(legend.position = "bottom")
  
  

# Advanced graph
ggplot(psych_summary,
       aes(x = time, y = mean, group = intervention_group, colour = intervention_group)) +
  
  geom_line(
    linewidth = 0.9
  ) +
  
  geom_errorbar(
    aes(ymin = ci_lower, ymax = ci_upper, colour = intervention_group),
    width = 0.08,
    position = position_dodge(0.07) # slightly offsets errorbar
  ) +
  
  geom_text_repel(
    aes(label = paste0("M = ", round(mean, 2), "\n  n = ", n),
        colour = intervention_group),
    size = 3,
    show.legend = FALSE # to remove character displayed by legend
  ) +
  
  scale_y_continuous(
    breaks = seq(40, 60, 2),
    labels = sprintf("%.2f", seq(40, 60, 2)),
  ) +
  
  labs(
    x = "Psychological well-being (Flourishing Scale)",
    y = "Mean",
    linetype = NULL,
    colour = NULL,
    caption = "The error bars represent t-based 95% confidence interval (CI) bars"
  ) +
  
  theme_minimal() +
  theme(legend.position = "bottom")
```

### Figure 5
```{r figure-5}
figure_5_data <- postpartum_depression %>% 
  select(intervention_group, pre_sf_12_pcs_physicalhealthscale, post_sf12_pcs, postnatal_sf_12_pcs) %>%
 drop_na() %>% 
  group_by(intervention_group) %>% 
  summarise(mean_pre = mean(pre_sf_12_pcs_physicalhealthscale),
            mean_post = mean(as.numeric(post_sf12_pcs)),
            mean_postnatal = mean(as.numeric(postnatal_sf_12_pcs)),
            sd_pre = sd(pre_sf_12_pcs_physicalhealthscale),
            sd_post = sd(as.numeric(post_sf12_pcs)),
            sd_postnatal = sd(as.numeric(postnatal_sf_12_pcs))) %>% 
  pivot_longer(cols = -intervention_group,
               names_to = c("statistic", "timepoint"),
               names_sep = "_",
               values_to = "value") %>% 
  pivot_wider(names_from = statistic,
              values_from = value) %>% 
  mutate(timepoint = factor(timepoint, levels = c("pre", "post", "postnatal"))) %>% 
  mutate(intervention_group = factor(intervention_group))

figure_5_graph_original <- figure_5_data %>% 
  ggplot(aes(x = timepoint, y = mean, group = intervention_group, linetype = intervention_group)) + 
  geom_line() +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
  scale_y_continuous(limits = c(35, 60)) +
  scale_linetype_manual(name = "", values = c("solid", "dashed"), labels = c("HIIT - High Intensity Interval Training Group", "EDU - Educational Intervention Group")) +
   scale_x_discrete(labels = c( pre ="Before the intervention\n(II Trimester of Pregnancy)", post = "After the Intervention\n(III Trimester of Pregnancy)", postnatal = "Follow Up\n(± 5 Moths Postpartum)"))+
  xlab(bold("Physical Health") ~ "(measured with the Short Form Health Survey - physical subscale") +
    theme(legend.position = "bottom")

#Improved Graph Code for Figure 5
figure_5_graph_improved <- figure_5_data %>% 
  ggplot(aes(x = timepoint, y = mean, group = intervention_group, colour = intervention_group)) + 
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), position = position_dodge(width = 0.1)) +
  scale_y_continuous(limits = c(35, 60)) +
  scale_linetype_manual(name = "", values = c("solid", "dashed"), labels = c("HIIT - High Intensity Interval Training Group", "EDU - Educational Intervention Group")) +
 scale_x_discrete(labels = c( pre ="Before the intervention\n(II Trimester of Pregnancy)", post = "After the Intervention\n(III Trimester of Pregnancy)", postnatal = "Follow Up\n(± 5 Moths Postpartum)"))+
  geom_text(aes(label = round(mean, 2))) +
  theme(legend.position = "bottom") 
  

figure_5_graph_original

figure_5_graph_improved


figure_5_graph_original + figure_5_graph_improved

```


## Task 2: FAIR data principles

## Task 3: Reproducibility brief

